---
- name: Create Earth Kafka Namespace
  k8s:
    api_version: v1
    kind: Namespace
    name: '{{ kafka_earth_namespace }}'
    state: present

- name: Create Earth Kafka Cluster
  k8s:
    state: present
    namespace: '{{ kafka_earth_namespace }}'
    resource_definition: "{{ lookup('template', 'kafka-earth.yaml.j2') }}"

- name: Create Earth Database Namespace
  k8s:
    api_version: v1
    kind: Namespace
    name: '{{ db_earth_namespace }}'
    state: present

- name: Enable anyuid on Earth Database Namespace
  shell: "oc adm policy add-scc-to-user anyuid -z default -n {{ db_earth_namespace }}"

- name: Check if DB has been deployed
  k8s_facts:
    kind: DeploymentConfig
    name: mssql-server-linux
    namespace: '{{ db_earth_namespace }}'
    api_version: v1
  register: db_exists

- name: Deploy DB
  block:
  - name: Deploy Earth Database
    shell: "oc new-app {{ mssqlserver_image }}:{{ mssqlserver_version }} \
            -e 'ACCEPT_EULA=Y' -e 'SA_PASSWORD=Password!' \
            -e 'MSSQL_PID=Standard' -e 'MSSQL_AGENT_ENABLED=true' \
            -n {{ db_earth_namespace }}"
  - name: Create Earth Data SQL ConfigMap
    k8s:
      state: present
      namespace: '{{ db_earth_namespace }}'
      resource_definition: "{{ lookup('template', 'configmap-data-sql.yaml.j2') }}"
  - name: Mount ConfigMap Volume
    shell: "oc set volume dc/mssql-server-linux --add --name=earth-data \
            --type=configmap --mount-path=/opt/workshop \
            --configmap-name=earth-data-sql -n {{ db_earth_namespace }}"
  when: (db_exists.resources is undefined) or (db_exists.resources | length == 0)

- name: Wait for db to start
  k8s_facts:
    kind: DeploymentConfig
    name: mssql-server-linux
    namespace: '{{ db_earth_namespace }}'
    api_version: v1
  register: dc
  until: dc.resources is defined and dc.resources | length > 0
  retries: 60
  delay: 30

- name: Set Expected Replicas
  set_fact:
    mssql_replicas: '{{ dc.resources[0].spec.replicas }}'

- name: Wait for mssql readiness
  k8s_facts:
    kind: DeploymentConfig
    name: mssql-server-linux
    namespace: '{{ db_earth_namespace }}'
    api_version: v1
  register: dc
  until: (dc.resources[0].status.readyReplicas is defined) and 
        ((dc.resources[0].status.readyReplicas | int) == (mssql_replicas | int))
  retries: 60
  delay: 30

- name: Get DB pod name
  k8s_facts:
    kind: Pod
    label_selectors:
      - deploymentconfig = mssql-server-linux
    namespace: '{{ db_earth_namespace }}'
    api_version: v1
  register: mssql_pods

- name: Set DB Pod Name
  set_fact:
    mssql_name: '{{ mssql_pods.resources[0].metadata.name }}'

- name: Load  data into db
  shell: oc exec -n {{ db_earth_namespace }} {{ mssql_name }} \
        -- /opt/mssql-tools/bin/sqlcmd -U sa -P 'Password!' \
        -i /opt/workshop/earth-data.sql

- name: Create Earth Application Namespace
  k8s:
    api_version: v1
    kind: Namespace
    name: '{{ app_earth_namespace }}'
    state: present

- name: Enable anyuid on Earth Database Namespace
  shell: "oc adm policy add-scc-to-user anyuid -z default -n {{ app_earth_namespace }}"

- name: Check if DB has been deployed
  k8s_facts:
    kind: DeploymentConfig
    name: my-apache-php-app
    namespace: '{{ app_earth_namespace }}'
    api_version: v1
  register: app_exists

- name: Deploy Application
  block:
  - name: Deploy Earth Application
    shell: "oc new-app quay.io/hguerreroo/my-apache-php-app:latest \
            -e 'SERVER_NAME=mssql-server-linux.{{ db_earth_namespace }}.svc' \
            -n {{ app_earth_namespace }}"
  - name: Create Earth Application Route
    shell: "oc expose service my-apache-php-app --name=www -n {{ app_earth_namespace }}"
  when: (app_exists.resources is undefined) or (app_exists.resources | length == 0)
